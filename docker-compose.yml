version: '3.4'

services:

  digitalbank.worker.transaction:
    image: digitalbank.worker.transaction
    container_name: digitalbank.worker.transaction
    build:
      context: ./
      dockerfile: DigitalBank.Api.Pub/DigitalBank.Api.Pub.Authenticate/DockerFile
    environment:
      ASPNETCORE_ENVIRONMENT: Development
    secrets:
     - MYSQL_CONNECTIONSTRING
     - JWT_SECRET
     - JWT_EXPIREHOURS
     - ENCRYPTOR_SECRET
     - RABBITMQ_HOST
     - RABBITMQ_PASSWORD
     - RABBITMQ_TRANSACTION_COUNT
     - RABBITMQ_TRANSACTION_EXCHANGE
     - RABBITMQ_TRANSACTION_QUEUE
     - RABBITMQ_TRANSACTION_RETRY
     - RABBITMQ_USER_NAME
     - RETRY_ATTEMPT_TRANSACTION
     - INTERVAL_ATTEMPT_TRANSACTION
    ports:
     - '9001:80'
    networks:
      - digital-bank
    depends_on:
     - mysqldb
     - rabbitmq 
     - digitalbank.migration

  digitalbank.migration:
    image: digitalbank.migration
    container_name: digitalbank.migration
    build:
      context: ./
      dockerfile: DigitalBank.Migrations/DigitalBank.Migration/DockerFile
    environment:
      ASPNETCORE_ENVIRONMENT: Development
    secrets:
     - MYSQL_CONNECTIONSTRING
    ports:
     - '8001:80'
    networks:
      - digital-bank
    depends_on:
     - mysqldb
     - rabbitmq 

  mysqldb:
    image: mysql:5.7
    container_name: mysqldb
    hostname: mysqldb
    environment:
     - MYSQL_ROOT_PASSWORD=digitalbank
     - MYSQL_DATABASE=digitalbank
     - MYSQL_USER=digitalbank
     - MYSQL_PASSWORD=!@12QWqw
     - TZ=America/Sao_Paulo
    ports:
      - '3306:3306'  
    volumes:
      - /data:/var/lib/mysql      
 
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    hostname: rabbitmq
    ports:
      - '5672:5672'
      - '15672:15672'
    networks:
      - digital-bank
    volumes:
     - /storage/rabbitmq:/var/lib/rabbitmq
    environment:
     - RABBITMQ_ERLANG_COOKIE=digitalbank
     - RABBITMQ_DEFAULT_USER=digitalbank
     - RABBITMQ_DEFAULT_PASS=!@12QWqw
     
secrets:
  MYSQL_CONNECTIONSTRING:
    file: secrets/MYSQL_CONNECTIONSTRING
  JWT_SECRET:
    file: ./secrets/JWT_SECRET
  JWT_EXPIREHOURS:
    file: ./secrets/JWT_EXPIREHOURS
  ENCRYPTOR_SECRET:
    file: ./secrets/ENCRYPTOR_SECRET
  RABBITMQ_HOST:
    file: ./secrets/RABBITMQ_HOST
  RABBITMQ_PASSWORD:
    file: ./secrets/RABBITMQ_PASSWORD
  RABBITMQ_TRANSACTION_COUNT:
    file: ./secrets/RABBITMQ_TRANSACTION_COUNT
  RABBITMQ_TRANSACTION_EXCHANGE:
    file: ./secrets/RABBITMQ_TRANSACTION_EXCHANGE   
  RABBITMQ_TRANSACTION_QUEUE:
    file: ./secrets/RABBITMQ_TRANSACTION_QUEUE
  RABBITMQ_TRANSACTION_RETRY:
    file: ./secrets/RABBITMQ_TRANSACTION_RETRY
  RABBITMQ_USER_NAME:
    file: ./secrets/RABBITMQ_USER_NAME
  RETRY_ATTEMPT_TRANSACTION:
    file: ./secrets/RETRY_ATTEMPT_TRANSACTION
  INTERVAL_ATTEMPT_TRANSACTION:
    file: ./secrets/INTERVAL_ATTEMPT_TRANSACTION
   
networks:
  digital-bank:
    driver: bridge 